---
globs: apps/api/*
alwaysApply: false
---

## ğŸ—ï¸ Architecture

### Module-Based Structure

```
src/modules/
â”œâ”€â”€ auth/
â”‚   â”œâ”€â”€ auth.dto.ts       # Schemas and types
â”‚   â”œâ”€â”€ auth.route.ts     # Route definitions
â”‚   â””â”€â”€ auth.guard.ts     # Middleware
â”œâ”€â”€ media/
â”‚   â”œâ”€â”€ media.dto.ts
â”‚   â”œâ”€â”€ media.route.ts
â”‚   â””â”€â”€ media.service.ts
â””â”€â”€ torrent/
    â”œâ”€â”€ torrent.dto.ts
    â”œâ”€â”€ torrent.route.ts
    â”œâ”€â”€ torrent.service.ts
    â””â”€â”€ torrent-download.service.ts
```

- Each module contains related routes, services, and DTOs
- Keep business logic in service classes
- Use guards for authentication/authorization
- Share utilities in `src/helpers/`

### DTO Pattern

Each module **must** have a `{module}.dto.ts` file containing:

- **Zod schemas** for validation (request/response)
- **TypeScript types** inferred from schemas
- **Database types** using drizzle-zod's `createSelectSchema` and `createInsertSchema`

#### Database Types

For database entities, use Drizzle-Zod to generate schemas:

```typescript
import { createSelectSchema, createInsertSchema } from "drizzle-zod";
import { user } from "@/db/schema";

// Database schemas
export const userSelectSchema = createSelectSchema(user);
export const userInsertSchema = createInsertSchema(user);

// Exported types
export type User = Omit<typeof userSelectSchema._output, "password">;
export type NewUser = typeof userInsertSchema._input;
```

#### Non-Database Types

For types that don't come from the database (e.g., API responses from external services):

```typescript
import { z } from "zod";

// Define Zod schema first
export const torrentSchema = z.object({
  title: z.string(),
  tracker: z.string(),
  size: z.number(),
  seeders: z.number(),
  // ... other fields
});

// Infer TypeScript type
export type Torrent = z.infer<typeof torrentSchema>;
```

### Type Exports

- **`schema.ts`**: Only export table definitions and enums (e.g., `IndexerType`, `UserRole`)
- **`{module}.dto.ts`**: Export all types and schemas for the module
- **`types.ts`**: Re-export only TypeScript types (not Zod schemas) for frontend consumption

### Service Pattern

- Extend `AuthenticatedService` for services needing database/user access
- Use dependency injection via context
- Keep services focused on business logic
- Handle errors appropriately
- Import types from DTOs, not from schema

Example:

```typescript
import { AuthenticatedService } from "@/classes/authenticated-service";
import type { Media } from "./media.dto";

export class MediaService extends AuthenticatedService {
  async getMediaById(id: number): Promise<Media | null> {
    return await this.db.select().from(media).where(eq(media.id, id)).get();
  }
}
```

## ğŸ›£ï¸ Hono Framework

### Route Definition

```typescript
import { Hono } from "hono";
import { zValidator } from "@hono/zod-validator";
import type { HonoVariables } from "@/types/hono";
import { createMediaSchema, mediaSelectSchema } from "./media.dto";
import { MediaService } from "./media.service";

export const mediaRoutes = new Hono<{ Variables: HonoVariables }>()
  .use("*", authGuard) // Apply middleware
  .get("/", async (c) => c.json(await MediaService.fromContext(c).getAll()))
  .post("/", zValidator("json", createMediaSchema), async (c) =>
    c.json(await MediaService.fromContext(c).create(c.req.valid("json")))
  );

export type MediaRoutesType = typeof mediaRoutes;
```

### Route Conventions

- Use RESTful conventions:
  - `GET /resource` - List resources
  - `GET /resource/:id` - Get single resource
  - `POST /resource` - Create resource
  - `PATCH /resource/:id` - Update resource
  - `DELETE /resource/:id` - Delete resource
- Group related routes in modules
- Apply middleware at appropriate levels
- Return appropriate HTTP status codes

### Middleware

- **authGuard**: Require authentication
- **requireRole**: Check user role
- Use middleware for cross-cutting concerns
- Order matters - apply in correct sequence

## ğŸ” Authentication & Authorization

### Session Management

- Use cookie-based sessions
- Set `httpOnly`, `secure`, `sameSite` flags
- Implement session expiration
- Clean up expired sessions

### Role-Based Access Control (RBAC)

- Roles: `viewer`, `member`, `admin`, `owner`
- `viewer`: Read-only access
- `member`: Can download torrents
- `admin`: User management
- `owner`: Full access

```typescript
// In routes
.use("/download/*", requireRole("member"))

// In services
if (!["admin", "owner"].includes(user.role)) {
  throw new Error("Unauthorized");
}
```

## ğŸ—„ï¸ Database (Drizzle ORM)

### Migrations

- Generate migrations: `pnpm db:generate`
- Apply migrations: `pnpm db:migrate`
- Push schema (dev): `pnpm db:push`
- Never edit migration files manually
- Test migrations before deploying

### Best Practices

- Use transactions for related operations
- Implement proper indexes for frequently queried columns
- Use prepared statements (Drizzle does this automatically)
- Implement soft deletes where appropriate
- Use foreign keys for referential integrity

## ğŸ“¦ Dependencies

### Core Dependencies

- **hono**: Web framework
- **drizzle-orm**: Database ORM
- **zod**: Schema validation
- **webtorrent**: Torrent client
- **ms**: Time utilities

### Adding Dependencies

- Check package size
- Verify TypeScript support
- Check maintenance status
- Review security vulnerabilities

## ğŸ“‹ Checklist Before Commit

- [ ] Routes are properly typed
- [ ] Validation schemas are defined
- [ ] Authentication/authorization is implemented
- [ ] Error handling is proper
- [ ] No typescript error + Linting passes (`pnpm check`)
- [ ] Sensitive data is not exposed

## ğŸš¨ Common Pitfalls to Avoid

âŒ **DON'T:**

- Trust user input
- Use `any` type
- Recreate types that already exist
- Export types from `schema.ts` (only tables and enums)
- Define inline Zod schemas in route files
- Hardcode configuration values
- Use synchronous file operations

âœ… **DO:**

- Define all schemas in DTO files
- Use `createSelectSchema` and `createInsertSchema` for database types
- Infer TypeScript types from Zod schemas
- Export only TypeScript types in `types.ts` (not Zod schemas)
- Import types from DTOs in route and service files
