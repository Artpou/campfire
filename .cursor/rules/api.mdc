---
description: API patterns for services, routers, and validators in tRPC monorepo
globs:
  [
    "packages/services/src/**/*.ts",
    "packages/trpc-router/src/**/*.ts",
    "packages/validators/src/**/*.validators.ts",
  ]
alwaysApply: true
---

# API Architecture Rules

## Service Files (`packages/services/src/*/*.service.ts`)

Services handle database operations using Drizzle ORM.

- Export a class with async methods for database queries
- Export a singleton instance: `export const entityService = new EntityService()`
- Methods return data types or `null`/`boolean` for operations
- Import from `@basement/db` for database and schema access
- Services are exported via package exports in `packages/services/package.json`
- Import services using: `import { entityService } from "@basement/services/entity"`

## Router Files (`packages/trpc-router/src/*/*.router.ts`)

Routers define tRPC procedures that use services and validators.

- Use `t` from `@basement/trpc-core` (tRPC instance is already created)
- Use `protectedProcedure` or `publicProcedure` from `@basement/trpc-core`
- Import validators from `@basement/validators/*.validators`
- Import services from `@basement/services/*`
- Define procedures with `.input()`, `.output()`, `.query()` or `.mutation()`
- Handle errors with `TRPCError` from `@trpc/server` or custom error classes (e.g., `NotFoundError`, `ConflictError`)
- Export router: `export const entityRouter = t.router({ ... })`

## Validator Files (`packages/validators/src/*.validators.ts`)

Validators define Zod schemas shared between backend and frontend.

- Use Zod for schema validation
- Export schemas: `*IdSchema`, `*InputSchema`, `*OutputSchema`
- Export inferred types: `export type EntityId = z.infer<typeof entityIdSchema>`
- Import from `zod`: `import { z } from "zod"`
- Validators are exported via package exports in `packages/validators/package.json`
- Import validators using: `import { entityIdSchema } from "@basement/validators/entity.validators"`

## Integration

- Routers are registered in `packages/trpc-router/src/index.ts`: `export const appRouter = t.router({ entity: entityRouter })`
- The app router is imported in `apps/api/src/server.ts` from `@basement/trpc-router`
- Validators are consumed by both backend (routers) and frontend (tRPC client)
